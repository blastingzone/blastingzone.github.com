<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1 maximum-scale=1.0, user-scalable=no"/>
    <script src="./lib/createjs-2015.11.26.combined.js"></script>
    <link rel="stylesheet" href="mod.css"/>
    <title></title>
</head>
<body>
<div id="canvasWrapper">
    <canvas id="canvas" width="800" height="600"></canvas>
</div>
</body>
<!-- key code data -->
<script src="./js/constKeyboardEventCode.js"></script>
<!-- game class -->
<script src="./js/inputManager.js"></script>
<script>
    const initWidth = 800;
    const initHeight = 600;
    var gameStage;
    var assetQueue;

    ////////////////////////////////////////////////////////////////////////////////////////////////
    // Main
    ////////////////////////////////////////////////////////////////////////////////////////////////
    window.onload = function(){
        loadAsset();
        initCanvas();
        activateTouch();
        addKeyboardEvent();
        console.log('Load Game');
    };

    ////////////////////////////////////////////////////////////////////////////////////////////////
    // init functions
    ////////////////////////////////////////////////////////////////////////////////////////////////
    function initCanvas(){
        gameStage = new createjs.Stage('canvas');
        createjs.Ticker.framerate = 30; // set 30fps
        createjs.Ticker.addEventListener('tick', function(e){
            if(!e.paused){
                globalUpdate();
                gameStage.update();
            }
        });

        resizeCanvas();
    }

    function activateTouch(){
        if(createjs.Touch.isSupported()){
            createjs.Touch.enable(gameStage);
        }
    }

    window.addEventListener('resize', function(e){
        resizeCanvas();
    });

    function resizeCanvas(){
        var scaleX = window.innerWidth/initWidth;
        var scaleY = window.innerHeight/initHeight;

        var scale = Math.min(scaleX, scaleY);
        gameStage.canvas.setAttribute('style', '-webkit-transform:scale(' + scale + ')');
        gameStage.canvas.setAttribute('style', 'transform:scale(' + scale + ')');

        var wrapper = document.getElementById('canvasWrapper');
        wrapper.style.top = (scale - 1) * initHeight / 2 + 'px';
        wrapper.style.left = (scale - 1) * initWidth / 2 + 'px';
    }

    function loadAsset(){
        loadImageAsset();
        loadSoundAsset();

        function loadImageAsset(){
            if(assetQueue == undefined){
                assetQueue = new createjs.LoadQueue();
            }
            assetQueue.addEventListener('complete', onLoadImageAssetComplete);
            assetQueue.loadManifest([
                {id:'warrior', src:'image/warrior.png'},
                {id:'mage', src:'image/mage.png'},
                {id:'archer', src:'image/archer.png'},
                {id:'bard', src:'image/bard.png'},
                {id:'background', src:'image/background.png'}
            ]);
        }

        function onLoadImageAssetComplete(){
            console.log('Load Image Complete');
            runTitleScene();
        }

        function loadSoundAsset(){
            if(assetQueue == undefined){
                assetQueue = new createjs.LoadQueue();
            }
            assetQueue.installPlugin(createjs.Sound);
            assetQueue.addEventListener('complete', onLoadSoundAssetComplete);
        }

        function onLoadSoundAssetComplete(){
            console.log('Load Sound Complete');
        }
    }

    function runTitleScene(){
        var bg = new createjs.Bitmap(assetQueue.getResult('background'));
        bg.x = bg.y = 0;
        gameStage.addChild(bg);
    }

    function addKeyboardEvent(){
        window.onkeydown = keyDownHandler;

        function keyDownHandler(e){
            console.debug(e);

            switch(e.keyCode) {
                case W_KEY:
                case ARROW_KEY_UP:
                    console.log("UP");
                    break;
                case S_KEY:
                case ARROW_KEY_DOWN:
                    console.log("DOWN");
                    break;
                case A_KEY:
                case ARROW_KEY_LEFT:
                    console.log("LEFT");
                    break;
                case D_KEY:
                case ARROW_KEY_RIGHT:
                    console.log("RIGHT");
                    break;
                case SPACE_KEY:
                    console.log("SPACE");
                    break;
                case ENTER_KEY:
                    console.log("ENTER");
                    break;
                default:
                    console.log(e.keyCode);
                    break;
            }
        }
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////
    // update functions
    ////////////////////////////////////////////////////////////////////////////////////////////////
    // game update root
    function globalUpdate(){

    }

    function testAddAsset(){
        var warrior = new createjs.Bitmap(assetQueue.getResult('warrior'));
        warrior.x = 100;
        warrior.y = 40;
        warrior.addEventListener('click', function(){ console.log('click warrior'); });
        gameStage.addChild(warrior);
    }

</script>
</html>