<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- jQuery -->
    <script src="./lib/jquery-1.11.3.min.js"></script>
    <!-- jQuery UI -->
    <script src="./lib/jquery-ui.js"></script>
    <!-- w3.css -->
    <link rel="stylesheet" href="./lib/w3.css">
    <link rel="stylesheet" id="theme_css" href="./lib/w3-theme-dark-grey.css">
    <!-- Google material Icon -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <!-- custom style sheet -->
    <link rel="stylesheet" media="all and (min-width : 960px)" href="./css/ytp/desktop.css" />
    <link rel="stylesheet" media="all and (min-width : 600px) and (max-width : 960px)" href="./css/ytp/tablet.css" />

    <title>Youtube Repeater</title>
    <style>
        .main_video_controller i {
            cursor: pointer;
            color: #808080;
        }
            .main_video_controller i:active {
                color: #000000;
            }
    </style>
</head>
<body>
    <header class="w3-container w3-theme-d2">
        <span class="w3-xxlarge">Y O U T U B E R E P E A T E R</span>
    </header>
    <!-- Title -->
    <div>

    </div>
    <!-- Main Player -->
    <div id="main_player_container" class="w3-container">
        <div class="video_container w3-card-4 video_droppable">
            <div id="main_video_player" class="video_player"></div>
            <!--
            <iframe class="video_player" src="https://www.youtube.com/embed/4GZUQFcht78" frameborder="0" allowfullscreen></iframe>
                -->
        </div>
        <!-- Video Controller -->
        <div class="main_video_controller">
            <i class="material-icons w3-xxxlarge">skip_previous</i>
            <i class="material-icons w3-xxxlarge">skip_next</i>
            <i class="material-icons w3-xxxlarge" onclick="g_videoController.pauseVideo()">pause</i>
            <i class="material-icons w3-xxxlarge" onclick="g_videoController.playVideo()">play_arrow</i>
            <i class="material-icons w3-xxxlarge" onclick="g_videoController.stopVideo()">stop</i>
        </div>
    </div>
    <!-- Mov Adder -->
    <div class="w3-container">
        <label for="youtube_url">Youtube URL</label>
        <input id="youtube_url" name="youtube_url" class="w3-input" type="text" value="" placeholder="Add Youtube URL" />
        <button class="w3-btn w3-slim" onclick="addNewVideo()">Add New Video</button>
    </div>
    <!-- Mov List -->
    <div class="w3-container w3-card-4 play_list_container">
        <div class="play_list_mov" data-mov-id="4GZUQFcht78">
            <img class="w3-circle" src="http://img.youtube.com/vi/4GZUQFcht78/1.jpg" />
        </div>
        <div class="play_list_mov" data-mov-id="sXD2eWLqzU0">
            <img class="w3-circle" src="http://img.youtube.com/vi/sXD2eWLqzU0/1.jpg" />
        </div>
        <div class="play_list_mov" data-mov-id="ci-L4ns4om8">
            <img class="w3-circle" src="http://img.youtube.com/vi/ci-L4ns4om8/1.jpg" />
        </div>
    </div>
</body>
</html>
<script type="text/javascript">
    // Ref :: https://developers.google.com/youtube/player_parameters?hl=ko

    ////////////////////////////////////////////////////////////////
    // VIdeoController Class
    ////////////////////////////////////////////////////////////////
    function VideoController() {
        console.log("Create Video Controller");
    }
    VideoController.prototype.setPlayer = function (player) {
        this.player = player;
    }
    VideoController.prototype.getPlayer = function () {
        return this.player;
    }
    VideoController.prototype.destroyPlayer = function () {
        if (this.player !== undefined && this.player !== null) {
            this.player.destroy();
        } else {
            this.player = null;
        }
    }
    VideoController.prototype.playVideo = function () {
        if (this.player !== undefined && this.player !== null) {
            this.player.playVideo();
        }
    }
    VideoController.prototype.stopVideo = function () {
        if (this.player !== undefined && this.player !== null) {
            this.player.stopVideo();
        }
    }
    VideoController.prototype.pauseVideo = function () {
        if (this.player !== undefined && this.player !== null) {
            this.player.pauseVideo();
        }
    }
    VideoController.prototype.onPlayerStateChange = function (event) {
        console.debug(event);
        switch (event.data) {
            case 0: // End Play -> Auto Replay
                event.target.playVideo();
                break;
            default:
                break;
        }
    }
    ////////////////////////////////////////////////////////////////

    var g_videoController = new VideoController();

    // Main
    $(document).ready(function () {
        initialLoadYoutubeAPI();
        initialVideoListSortable();
        initialVideoListDraggable();
    });

    function getEmbedYoutubeUrl(url) {
        var embedKeyword = 'embed/';
        var originalKeyword = '/watch?v=';
        var listKeyword = '&list';

        if (url.search(embedKeyword) !== -1) {
            // 1. embed url일 경우
            return url.slice(url.lastIndexOf(embedKeyword) + embedKeyword.length);
        } else {
            // 2. 생짜 url일 경우
            if (url.search(listKeyword) !== -1) {
                // 2-1. 생짜 url인데 플레이리스트가 같이 있을 경우
                // 플레이 리스트를 살리는 케이스 (YT Player에서는 사용 불가)
                //return url.slice(url.lastIndexOf(originalKeyword) + originalKeyword.length).replace('&', '?');
                // 플레이 리스트를 제거하는 케이스
                return url.slice(url.lastIndexOf(originalKeyword) + originalKeyword.length, url.indexOf('&'));
            } else {
                // 2-2. 생짜 url이고 플레이리스트가 없는 경우
                return url.slice(url.lastIndexOf(originalKeyword) + originalKeyword.length);
            }
        }
    }

    function initialVideoListSortable() {
        $('.play_list_container').sortable();
        $('.play_list_container').disableSelection();
    }

    function initialVideoListDraggable() {
        $('.video_droppable').droppable({
            accept: ".play_list_mov",
            drop: function (event, ui) {
                console.debug(ui);
                var curVideoObject = ui.helper[0];
                // drop video object
                if ($(curVideoObject).hasClass('play_list_mov')) {
                    g_videoController.destroyPlayer();
                    var videoID = $(curVideoObject).attr('data-mov-id');
                    
                    setVideoPlayer(videoID);
                }
            }
        });
    }

    function setVideoPlayer(videoID) {
        var player = new YT.Player('main_video_player', {
            videoId: videoID,
            events: {
                'onStateChange': g_videoController.onPlayerStateChange
            }
        });
        console.log(videoID);
        g_videoController.setPlayer(player);
    }

    function initialLoadYoutubeAPI() {
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/player_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        // YouTube player after the API code downloads.
        function onYouTubePlayerAPIReady() {

        }
    }

    function addNewVideo() {
        var url_input = $('#youtube_url');
        var url = url_input.val();

        if (url == null || url == undefined || url == "") {
            return;
        }

        video_id = getEmbedYoutubeUrl(url);

        var videoObj = createVideoObject(video_id);
        $('.play_list_container').append(videoObj);

        url_input.val(""); // empty input
    }

    function createVideoObject(video_id) {
        return '<div class="play_list_mov" data-mov-id=' + video_id + '><img class="w3-circle" src="http://img.youtube.com/vi/' + video_id + '/0.jpg" /></div>';
    }
</script>